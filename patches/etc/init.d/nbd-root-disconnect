#!/sbin/runscript
# Copyright (c) 2015 Online Labs Cloud Team <cloud-team@labs.online.net>
# Released under the MIT license.

description="Disconnects NBD root volume."

depend() {
    need killprocs savecache mount-ro
}

start() {
    # keep these binaries in cache
    cat /sbin/{halt,reboot,shutdown} > /dev/null
    ebegin "Disconnecting root NBD volume"
    /usr/local/sbin/nbd-client -d /dev/nbd0
    eend $?
    echo b > /proc/sysrq-trigger
}
